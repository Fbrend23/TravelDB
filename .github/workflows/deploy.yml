name: Deploy Production

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # JOB 1 : FRONTEND (Vue.js) FTP
  # ------------------------------------------------------------------
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Build Frontend
        working-directory: ./frontend

        run: |
          npm ci
          npm run build

      - name: Deploy Frontend via FTP
        uses: SamKirkland/FTP-Deploy-Action@a51268f67f6605236975928ae28b0f7e9971d50a
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}

          local-dir: ./frontend/dist/
          server-dir: /
          protocol: ftp
          exclude: |
            **/.git*
            **/.git*/**

  # ------------------------------------------------------------------
  # JOB 2 : BACKEND (AdonisJS) SSH
  # ------------------------------------------------------------------
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Build Backend
        working-directory: ./backend
        run: |
          npm ci
          npm install @swc/core-linux-x64-gnu --no-save
          npm run build

      - name: Archive Production Artifact
        run: |
          tar -czf backend-build.tar.gz -C backend/build .

      - name: Install SSHPass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Copy build via SCP (Password)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          echo "Nettoyage..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /srv/customer/temp_deploy/ && rm -rf /srv/customer/temp_deploy/*"

          echo "Envoi..."
          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -P ${{ secrets.SSH_PORT }} backend-build.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/srv/customer/temp_deploy/

      - name: Copy build via SCP
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /srv/customer/temp_deploy/ && rm -rf /srv/customer/temp_deploy/*"

          sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -P ${{ secrets.SSH_PORT }} backend-build.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/srv/customer/temp_deploy/

      - name: Remote Install & Restart
        run: |
          sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            TARGET_DIR="/srv/customer/sites/${{ secrets.SSH_PATH }}"
            TEMP_DIR="/srv/customer/temp_deploy"
            
            mkdir -p $TARGET_DIR
            tar -xzf $TEMP_DIR/backend-build.tar.gz -C $TARGET_DIR/

            cd $TARGET_DIR
            npm ci --production

            mkdir -p tmp
            touch tmp/restart.txt

            rm $TEMP_DIR/backend-build.tar.gz
          '